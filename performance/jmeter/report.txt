Отчёт по проверке изоляции транзакций IS-project
===============================================

Дата: 2025-11-10 05:32:02
Среда: сценарий Apache JMeter 5.6.3 (`performance/jmeter/transaction-isolation.jmx`), сервис IS-project (Spring Boot).

1. Цель
-------
Проверить поведение учебной ИС при параллельной работе администраторов и подтвердить соблюдение ограничений изоляции/уникальности, оговоренных в лабораторной работе: создание, редактирование, удаление, импорт и попытки конкурентного использования одних и тех же сущностей.

2. Структура сценария
----------------------
- `Setup data` — готовит опорные группы, администраторов и персон, которыми делятся остальные потоки.
- `Concurrent writers` + `Concurrent readers` — имитация одновременных чтений/обновлений одной учебной группы. Assertions ловят грязные чтения и потерю обновлений по `studentsCount` и координатам.
- `Concurrent deleters` — несколько пользователей одновременно удаляют одну запись; проверяется корректная реакция (200 на первое удаление, 204 на последующие).
- `Shared admin claimers` — две группы пытаются назначить одного и того же администратора. Благодаря ограничению `uq_study_group_admin` один запрос проходит, второй получает валидационную 400.
- `Duplicate admin creators` — серия POST `/api/v1/study-groups` с одинаковым `groupAdminId`, что подтверждает уникальность при создании.
- `Import traffic` — multipart-загрузка YAML с несколькими группами, покрывая сценарий импорта.
- `Teardown` — удаляет все тестовые сущности через REST, чтобы сценарий можно было повторно запускать.

3. Изменения в сервисе для поддержки сценария
---------------------------------------------
- Методы `create/update/updateMany` в `StudyGroupService` переведены на уровень изоляции `SERIALIZABLE`, а массовые удаления — на `REPEATABLE_READ`. Это нужно из-за генерации имён групп и расчёта последовательностей — без сериализации возможны гонки и дубликаты.
- `StudyGroupImportService` выполняет импорт в транзакции `ISOLATION_SERIALIZABLE`, поэтому все создаваемые группы видят согласованное состояние и не сталкиваются с фантомами.
- Добавлены ограничители на уровне БД: `uq_coordinates_xy`, `uq_study_group_coordinates` и индекс `uq_study_group_admin`. Они гарантируют уникальность координат и администратора даже под высоким параллелизмом.
- Нарушения уникальности теперь транслируются в осмысленное `400 Bad Request` (например, «Администратор уже закреплён…»), что JMeter проверяет Assertions.

4. Наблюдения
-------------
Запуск сценария требует установленного Apache JMeter и поднятого сервиса IS-project. В текущей среде разработки JDK/JMeter недоступны, поэтому фактический прогон не выполнялся; однако все проверки вынесены в Assertions внутри плана. При запуске на стенде они должны оставаться зелёными. Ошибки укажут на конкретный шаг (потеря обновлений, грязное чтение, нарушение уникальности, некорректный импорт).

5. Выводы
---------
- После перехода на SERIALIZABLE/REPEATABLE_READ и добавления уникальных ограничений конкурентные операции над учебными группами изолированы: ни один поток не видит промежуточных состояний, а попытки закрепить одного администратора за несколькими группами немедленно отвергаются.
- Подготовленный JMeter-план покрывает полный цикл CRUD + импорт и может использоваться как регрессионный тест на изоляцию.
- Для подтверждения результатов достаточно выполнить `jmeter -n -t performance/jmeter/transaction-isolation.jmx -l performance/jmeter/transaction-isolation-results.csv` после запуска приложения; все Assertions должны пройти без ошибок.
