# Сценарий проверки изоляции транзакций (Apache JMeter)

`transaction-isolation.jmx` моделирует одновременную работу нескольких администраторов ИС и покрывает все критичные операции:

- **Создание:** поток `Duplicate admin creators` пытается создать несколько групп на одного и того же администратора (`groupAdminId`). Только один запрос должен пройти, остальные получают корректную ошибку о нарушении уникальности.
- **Редактирование:** `Concurrent writers` массово меняют `studentsCount` у одной группы, контролируя, что сервер возвращает подтверждённое значение и не теряет обновления. Параллельно `Concurrent readers` убеждаются, что не наблюдают «грязных» данных.
- **Удаление:** `Concurrent deleters` одновременно отправляют `DELETE` для одной и той же группы; JMeter проверяет, что сервер либо удаляет запись, либо корректно сообщает об отсутствии (204).
- **Импорт:** `Import traffic` отправляет multipart‑запрос на `/api/v1/imports/study-groups` с готовым YAML, имитируя пакетную загрузку из ЛР.
- **Конкуренция за администраторов:** `Shared admin claimers` одновременно назначают одного человека на две группы, демонстрируя сериализуемость при изменении бизнес-ограничения «один админ — одна группа».
- **Обеспечение изоляции при подготовке данных:** `Setup data` создаёт сущности, которыми делятся остальные потоки, а `Teardown` удаляет их через REST API, чтобы сценарий можно было повторно запускать.

## Требования

- Apache JMeter 5.6.3+ (сценарий собирался под 5.6.3).
- Запущенное приложение IS-project по адресу `http://localhost:8080`. Измените `protocol/host/port` в Test Plan → User Defined Variables при необходимости.
- Файл примера импортa `example/example.yaml` (используется по умолчанию) или собственный YAML.

## Запуск

### GUI

1. Запустите JMeter (`jmeter &` или `./bin/jmeter`).
2. Откройте `performance/jmeter/transaction-isolation.jmx`.
3. При необходимости скорректируйте переменные окружения и размерности потоков.
4. Нажмите **Start** и наблюдайте `Summary Report` / `View Results Tree`.

### CLI

```bash
jmeter -n -t performance/jmeter/transaction-isolation.jmx \
       -l performance/jmeter/transaction-isolation-results.csv
```

CSV путь уже зашит в плане, но можно переопределить через `-l`.

## Что проверять по итогам

- Все Assertions должны быть зелёными. Именно они фиксируют нарушение изоляции (появление грязных чтений, потерю обновлений или допуск дубликата администратора).
- В `Summary Report` следим за `Error %`. Значение &gt;0 сигнализирует о регрессе.
- При необходимости анализируем `performance/jmeter/transaction-isolation-results.csv` (колонки `success`, `responseCode`, `failureMessage`).

Если тест завершается без ошибок, значит:

1. Транзакции `create/update/delete/import` выдерживают параллельные обращения без потери данных.
2. Ограничения уникальности предметной области (координаты, администратор) соблюдаются даже при гонках.
3. Уровни изоляции, заданные в сервисах, предотвращают неповторяемые чтения и «попытки присвоения» одного администратора нескольким группам.
