# Сценарий проверки изоляции транзакций (Apache JMeter)

Файл [`transaction-isolation.jmx`](transaction-isolation.jmx) моделирует параллельную работу пользователей ИС и подтверждает, что транзакции `StudyGroupService` исполняются изолированно, без «грязных» чтений и потери обновлений.

## Что именно проверяется

- **Setup Thread Group** создаёт опорную учебную группу через `POST /api/v1/study-groups` и передаёт её `id` остальным потокам через JMeter properties. Операция выполняется под транзакцией `create`.
- **Concurrent writers** (10 потоков × 20 итераций) читают одну и ту же группу, рассчитывают новое значение `studentsCount` и отправляют `PATCH /api/v1/study-groups/{id}`. JSON Assertion проверяет, что сервер возвращает именно то значение, которое было отправлено, тем самым фиксируя отсутствие «потерянных» обновлений.
- **Concurrent readers** (12 потоков × 40 итераций) выполняют только `GET /api/v1/study-groups/{id}`. JSR223 Assertion анализирует ответ и убеждается, что:
  - `studentsCount` не выходит ниже допустимого порога (10) во время параллельных изменений;
  - координаты присутствуют и их `x` остаётся положительным, т.е. читатели не видят частично обновлённые сущности.
- **Teardown Thread Group** повторно читает итоговое состояние, после чего удаляет тестовую запись (`DELETE /api/v1/study-groups/{id}`), чтобы сценарий был идемпотентным.

Таким образом, тест одновременно валидирует read/write операции и контролирует, что транзакции, описанные в ЛР, не допускают грязных чтений или неконсистентных данных.

## Требования

- Apache JMeter 5.6.3+ (тест создавался под 5.6.3).
- Запущенное приложение IS-project по адресу `http://localhost:8080` (при необходимости измените переменные `protocol`, `host`, `port` в Test Plan → User Defined Variables).
- Пустая/контролируемая база данных, чтобы тестовые данные не конфликтовали с реальными.

## Как запустить

### Через GUI

1. `jmeter &` (или `./bin/jmeter` в каталоге установки).
2. Открыть `performance/jmeter/transaction-isolation.jmx`.
3. (Опционально) откройте вкладку **User Defined Variables** и подправьте `protocol/host/port`.
4. Запустите тест (кнопка Start). Наблюдайте за **Summary Report** и **View Results Tree**.

### Через CLI

```bash
jmeter -n -t performance/jmeter/transaction-isolation.jmx \
       -l performance/jmeter/transaction-isolation-results.csv
```

Файл отчёта указан в самом плане (`Result Collector`). При необходимости можно переопределить путь ключом `-l`.

## Интерпретация результатов

- Все сэмплы должны завершиться без ошибок. При нарушении изоляции упадёт либо JSON Assertion в потоках записи, либо JSR223 Assertion у читателей.
- В **Summary Report** фиксируем throughput и средние задержки. Резкий рост `Error %` свидетельствует о некорректной конкуренции (например, сервер вернул 409/500 из‑за блокировок).
- Для дополнительной проверки можно открыть `performance/jmeter/transaction-isolation-results.csv` и убедиться, что нет записей с `success=false`.

Если Assertions проходят, это означает, что параллельные транзакции `create/update/get/delete` выполняются последовательно и клиенты не наблюдают промежуточные состояния — требование ЛР по проверке изоляции выполнено.
